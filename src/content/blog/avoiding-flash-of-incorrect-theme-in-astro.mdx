---
title: Avoiding flash of incorrect theme in Astro
format: article
published: '2024-05-05'
short: 'TODO'
cover: './covers/an-ai-love-letter.png'
coverAlt: 'TODO'
readingTime: 'TODO'
tags: ['TODO']
---

If you apply a users theme preference from localStorage or from the prefers-color-scheme media query in Astro, you will probably notice a flash of the incorrect theme being applied on page load. This effect will be exaggerated by a transition on colours.

This is happening because the page content is being rendered with the default theme before your JavaScript can apply the correct theme. A solution to the flash of incorrect theme problem in Astro is to apply the correct theme from a script in the `<head>`, before the browser renders the page. This ensures that the correct theme is applied as early as possible, preventing the brief flash of the incorrect theme.

My dark theme is applied by adding a `"dark"` class to my `<html>` element. For a simple way to toggle dark mode in this way with an `.astro` component, see this tutorial from the Astro docs:  
[Back on dry land. Take your blog from day to night, no island required!](https://docs.astro.build/en/tutorial/6-islands/2/)

Here is the script we will put in the head:

```js title="src/lib/persistTheme.js"
;(() => {
	const preference =
		// if localStorage theme already exists, use that
		localStorage.getItem('theme') ??
		// else use user's system preference
		(window.matchMedia('(prefers-color-scheme: dark)').matches
			? 'dark'
			: 'light')

	document.documentElement.classList.toggle('dark', preference === 'dark')

	// persist theme to localStorage when mutation observed on <html>
	const themeObserver = new MutationObserver(() => {
		const isDark = document.documentElement.classList.contains('dark')
		localStorage.setItem('theme', isDark ? 'dark' : 'light')
	})
	themeObserver.observe(document.documentElement, {
		attributes: true,
		attributeFilter: ['class']
	})
})()
```

This will run before the `<body>` is parsed and rendered, ensuring that the correct theme is applied as early as possible.

To minify, you can run:

```bash
terser src/lib/persistTheme.js --mangle --output src/lib/persistTheme.min.js
```

or copy:

{/* prettier-ignore-start */}
```js title="src/lib/persistTheme.min.js"
(()=>{const e=localStorage.getItem("theme")??(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");document.documentElement.classList.toggle("dark",e==="dark");const t=new MutationObserver((()=>{const e=document.documentElement.classList.contains("dark");localStorage.setItem("theme",e?"dark":"light")}));t.observe(document.documentElement,{attributes:true,attributeFilter:["class"]})})();
```
{/* prettier-ignore-end */}

## Including the script

To include this script in the head, in your Astro layout:

- Import the minified script as a string using the [`?raw`](https://vitejs.dev/guide/assets#importing-asset-as-string) suffix.
- Add the script to the `<head>` using the [`is:inline`](https://docs.astro.build/en/reference/directives-reference/#isinline) directive.

> `is:inline` tells Astro to leave the `<script>` or `<style>` tag as-is in the final output HTML. The contents will not be processed, optimized, or bundled.

{/* prettier-ignore-start */}
```astro title="src/layouts/Layout.astro" ins={2, 10}
---
import persistTheme from '@/lib/persistTheme.min.js?raw'
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script is:inline set:html={persistTheme} />
		...
```
{/* prettier-ignore-end */}

---

### Additional Resources

For more information about implementing dark mode, read:  
[A Complete Guide to Dark Mode on the Web](https://css-tricks.com/a-complete-guide-to-dark-mode-on-the-web/)

My solution was inspired by this comment on reddit:  
[/r/webdev/comments/16iu3uf/comment/k0n4ds2](https://www.reddit.com/r/webdev/comments/16iu3uf/comment/k0n4ds2)

### Supplementary Material

Below is my implementation of a theme toggle button. It is a Vue component designed to simply toggle the `"dark"` class on the `<html>` element. I am using the [`<Toggle>`](https://www.shadcn-vue.com/docs/components/toggle.html) component is from [shadcn-vue](https://www.shadcn-vue.com/).

```vue
<script setup lang="ts">
// only toggles 'dark' class in <html> element classList
// see @/lib/persistTheme.js for rest of implementation
import { ref, watch } from 'vue'

import IconMoon from '@/components/icons/IconMoon.vue'
import IconSun from '@/components/icons/IconSun.vue'
import { Toggle } from '@/components/ui/toggle'

const state = ref(
	document.documentElement.classList.contains('dark') ? true : false
)

watch(state, (val) => document.documentElement.classList.toggle('dark', val))
</script>

<template>
	<Toggle
		v-model:pressed="state"
		size="icon"
		variant="theme"
		aria-label="Toggle dark mode"
	>
		<IconSun v-show="state === false" class="h-6 w-6" />
		<IconMoon v-show="state === true" class="h-6 w-6" />
	</Toggle>
</template>
```
